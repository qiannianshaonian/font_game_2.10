{
  "code": "import { Node } from \"./Node\";\r\nimport { Const } from \"../Const\";\r\nimport { Sprite } from \"./Sprite\";\r\nimport { Event } from \"../events/Event\";\r\nimport { SceneLoader } from \"../net/SceneLoader\";\r\nimport { Resource } from \"../resource/Resource\";\r\nimport { Handler } from \"../utils/Handler\";\r\nimport { SceneUtils } from \"../utils/SceneUtils\";\r\nimport { ILaya } from \"../../ILaya\";\r\nimport { ClassUtils } from \"../utils/ClassUtils\";\r\nimport { URL } from \"../net/URL\";\r\nexport class Scene extends Sprite {\r\n    constructor(createChildren = true) {\r\n        super();\r\n        this.autoDestroyAtClosed = false;\r\n        this.url = null;\r\n        this._viewCreated = false;\r\n        this._idMap = null;\r\n        this._$componentType = \"Scene\";\r\n        Scene.unDestroyedScenes.push(this);\r\n        this._scene = this;\r\n        if (createChildren)\r\n            this.createChildren();\r\n    }\r\n    createChildren() {\r\n    }\r\n    static setUIMap(url) {\r\n        let uimap = ILaya.loader.getRes(url);\r\n        if (uimap) {\r\n            for (let key in uimap) {\r\n                ILaya.Loader.loadedMap[URL.formatURL(key + \".scene\")] = uimap[key];\r\n            }\r\n        }\r\n        else {\r\n            throw \"请提前加载uimap的json，再使用该接口设置！\";\r\n        }\r\n    }\r\n    loadScene(path) {\r\n        var url = path.indexOf(\".\") > -1 ? path : path + \".scene\";\r\n        var view = ILaya.loader.getRes(url);\r\n        if (view) {\r\n            this.createView(view);\r\n        }\r\n        else {\r\n            this._setBit(Const.NOT_READY, true);\r\n            ILaya.loader.resetProgress();\r\n            var loader = new SceneLoader();\r\n            loader.on(Event.COMPLETE, this, this._onSceneLoaded, [url]);\r\n            loader.load(url);\r\n        }\r\n    }\r\n    _onSceneLoaded(url) {\r\n        this.createView(ILaya.Loader.getRes(url));\r\n    }\r\n    createView(view) {\r\n        if (view && !this._viewCreated) {\r\n            this._viewCreated = true;\r\n            SceneUtils.createByData(this, view);\r\n        }\r\n    }\r\n    getNodeByID(id) {\r\n        if (this._idMap)\r\n            return this._idMap[id];\r\n        return null;\r\n    }\r\n    open(closeOther = true, param = null) {\r\n        if (closeOther)\r\n            Scene.closeAll();\r\n        Scene.root.addChild(this);\r\n        this.onOpened(param);\r\n    }\r\n    onOpened(param) {\r\n    }\r\n    close(type = null) {\r\n        this.onClosed(type);\r\n        if (this.autoDestroyAtClosed)\r\n            this.destroy();\r\n        else\r\n            this.removeSelf();\r\n    }\r\n    onClosed(type = null) {\r\n    }\r\n    destroy(destroyChild = true) {\r\n        this._idMap = null;\r\n        super.destroy(destroyChild);\r\n        var list = Scene.unDestroyedScenes;\r\n        for (var i = list.length - 1; i > -1; i--) {\r\n            if (list[i] === this) {\r\n                list.splice(i, 1);\r\n                return;\r\n            }\r\n        }\r\n    }\r\n    set scaleX(value) {\r\n        if (super.get_scaleX() == value)\r\n            return;\r\n        super.set_scaleX(value);\r\n        this.event(Event.RESIZE);\r\n    }\r\n    get scaleX() {\r\n        return super.scaleX;\r\n    }\r\n    set scaleY(value) {\r\n        if (super.get_scaleY() == value)\r\n            return;\r\n        super.set_scaleY(value);\r\n        this.event(Event.RESIZE);\r\n    }\r\n    get scaleY() {\r\n        return super.scaleY;\r\n    }\r\n    get width() {\r\n        if (this._width)\r\n            return this._width;\r\n        var max = 0;\r\n        for (var i = this.numChildren - 1; i > -1; i--) {\r\n            var comp = this.getChildAt(i);\r\n            if (comp._visible) {\r\n                max = Math.max(comp._x + comp.width * comp.scaleX, max);\r\n            }\r\n        }\r\n        return max;\r\n    }\r\n    set width(value) {\r\n        if (super.get_width() == value)\r\n            return;\r\n        super.set_width(value);\r\n        this.callLater(this._sizeChanged);\r\n    }\r\n    get height() {\r\n        if (this._height)\r\n            return this._height;\r\n        var max = 0;\r\n        for (var i = this.numChildren - 1; i > -1; i--) {\r\n            var comp = this.getChildAt(i);\r\n            if (comp._visible) {\r\n                max = Math.max(comp._y + comp.height * comp.scaleY, max);\r\n            }\r\n        }\r\n        return max;\r\n    }\r\n    set height(value) {\r\n        if (super.get_height() == value)\r\n            return;\r\n        super.set_height(value);\r\n        this.callLater(this._sizeChanged);\r\n    }\r\n    _sizeChanged() {\r\n        this.event(Event.RESIZE);\r\n    }\r\n    static get root() {\r\n        if (!Scene._root) {\r\n            Scene._root = ILaya.stage.addChild(new Sprite());\r\n            Scene._root.name = \"root\";\r\n            ILaya.stage.on(\"resize\", null, () => {\r\n                Scene._root.size(ILaya.stage.width, ILaya.stage.height);\r\n                Scene._root.event(Event.RESIZE);\r\n            });\r\n            Scene._root.size(ILaya.stage.width, ILaya.stage.height);\r\n            Scene._root.event(Event.RESIZE);\r\n        }\r\n        return Scene._root;\r\n    }\r\n    get timer() {\r\n        return this._timer || ILaya.timer;\r\n    }\r\n    set timer(value) {\r\n        this._timer = value;\r\n    }\r\n    static load(url, complete = null, progress = null) {\r\n        ILaya.loader.resetProgress();\r\n        var loader = new SceneLoader();\r\n        loader.on(Event.PROGRESS, null, onProgress);\r\n        loader.once(Event.COMPLETE, null, create);\r\n        loader.load(url);\r\n        function onProgress(value) {\r\n            if (Scene._loadPage)\r\n                Scene._loadPage.event(\"progress\", value);\r\n            progress && progress.runWith(value);\r\n        }\r\n        function create() {\r\n            loader.off(Event.PROGRESS, null, onProgress);\r\n            var obj = ILaya.Loader.getRes(url);\r\n            if (!obj)\r\n                throw \"Can not find scene:\" + url;\r\n            if (!obj.props)\r\n                throw \"Scene data is error:\" + url;\r\n            var runtime = obj.props.runtime ? obj.props.runtime : obj.type;\r\n            var clas = ILaya.ClassUtils.getClass(runtime);\r\n            if (obj.props.renderType == \"instance\") {\r\n                var scene = clas.instance || (clas.instance = new clas());\r\n            }\r\n            else {\r\n                scene = new clas();\r\n            }\r\n            if (scene && scene instanceof Node) {\r\n                scene.url = url;\r\n                if (scene._viewCreated) {\r\n                    complete && complete.runWith(scene);\r\n                }\r\n                else {\r\n                    scene.on(\"onViewCreated\", null, function () {\r\n                        complete && complete.runWith(scene);\r\n                    });\r\n                    scene.createView(obj);\r\n                }\r\n                Scene.hideLoadingPage();\r\n            }\r\n            else {\r\n                throw \"Can not find scene:\" + runtime;\r\n            }\r\n        }\r\n    }\r\n    static open(url, closeOther = true, param = null, complete = null, progress = null) {\r\n        if (param instanceof Handler) {\r\n            var temp = complete;\r\n            complete = param;\r\n            param = temp;\r\n        }\r\n        Scene.showLoadingPage();\r\n        Scene.load(url, Handler.create(null, this._onSceneLoaded, [closeOther, complete, param]), progress);\r\n    }\r\n    static _onSceneLoaded(closeOther, complete, param, scene) {\r\n        scene.open(closeOther, param);\r\n        if (complete)\r\n            complete.runWith(scene);\r\n    }\r\n    static close(url, name = \"\") {\r\n        var flag = false;\r\n        var list = Scene.unDestroyedScenes;\r\n        for (var i = 0, n = list.length; i < n; i++) {\r\n            var scene = list[i];\r\n            if (scene && scene.parent && scene.url === url && scene.name == name) {\r\n                scene.close();\r\n                flag = true;\r\n            }\r\n        }\r\n        return flag;\r\n    }\r\n    static closeAll() {\r\n        var root = Scene.root;\r\n        for (var i = 0, n = root.numChildren; i < n; i++) {\r\n            var scene = root.getChildAt(0);\r\n            if (scene instanceof Scene)\r\n                scene.close();\r\n            else\r\n                scene.removeSelf();\r\n        }\r\n    }\r\n    static destroy(url, name = \"\") {\r\n        var flag = false;\r\n        var list = [].concat(Scene.unDestroyedScenes);\r\n        for (var i = 0, n = list.length; i < n; i++) {\r\n            var scene = list[i];\r\n            if (scene.url === url && scene.name == name && !scene.destroyed) {\r\n                scene.destroy();\r\n                flag = true;\r\n            }\r\n        }\r\n        return flag;\r\n    }\r\n    static gc() {\r\n        Resource.destroyUnusedResources();\r\n    }\r\n    static setLoadingPage(loadPage) {\r\n        if (Scene._loadPage != loadPage) {\r\n            Scene._loadPage = loadPage;\r\n        }\r\n    }\r\n    static showLoadingPage(param = null, delay = 500) {\r\n        if (Scene._loadPage) {\r\n            ILaya.systemTimer.clear(null, Scene._showLoading);\r\n            ILaya.systemTimer.clear(null, Scene._hideLoading);\r\n            ILaya.systemTimer.once(delay, null, Scene._showLoading, [param], false);\r\n        }\r\n    }\r\n    static _showLoading(param) {\r\n        ILaya.stage.addChild(Scene._loadPage);\r\n        Scene._loadPage.onOpened(param);\r\n    }\r\n    static _hideLoading() {\r\n        Scene._loadPage.close();\r\n    }\r\n    static hideLoadingPage(delay = 500) {\r\n        if (Scene._loadPage) {\r\n            ILaya.systemTimer.clear(null, Scene._showLoading);\r\n            ILaya.systemTimer.clear(null, Scene._hideLoading);\r\n            ILaya.systemTimer.once(delay, null, Scene._hideLoading);\r\n        }\r\n    }\r\n}\r\nScene.unDestroyedScenes = [];\r\nILaya.regClass(Scene);\r\nClassUtils.regClass(\"laya.display.Scene\", Scene);\r\nClassUtils.regClass(\"Laya.Scene\", Scene);\r\n",
  "references": [
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/display/Node.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/Const.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/display/Sprite.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/events/Event.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/net/SceneLoader.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/resource/Resource.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/utils/Handler.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/utils/SceneUtils.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/utils/Timer.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/ILaya.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/utils/ClassUtils.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/net/URL.ts"
  ],
  "dts": {
    "name": "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/display/Scene.d.ts",
    "writeByteOrderMark": false,
    "text": "import { Sprite } from \"./Sprite\";\r\nimport { Handler } from \"../utils/Handler\";\r\nimport { Timer } from \"../utils/Timer\";\r\nexport declare class Scene extends Sprite {\r\n    static unDestroyedScenes: any[];\r\n    private static _root;\r\n    private static _loadPage;\r\n    autoDestroyAtClosed: boolean;\r\n    url: string;\r\n    private _timer;\r\n    private _viewCreated;\r\n    _idMap: any;\r\n    _$componentType: string;\r\n    constructor(createChildren?: boolean);\r\n    protected createChildren(): void;\r\n    static setUIMap(url: any): void;\r\n    loadScene(path: string): void;\r\n    private _onSceneLoaded;\r\n    createView(view: any): void;\r\n    getNodeByID(id: number): any;\r\n    open(closeOther?: boolean, param?: any): void;\r\n    onOpened(param: any): void;\r\n    close(type?: string): void;\r\n    onClosed(type?: string): void;\r\n    destroy(destroyChild?: boolean): void;\r\n    scaleX: number;\r\n    scaleY: number;\r\n    width: number;\r\n    height: number;\r\n    protected _sizeChanged(): void;\r\n    static readonly root: Sprite;\r\n    timer: Timer;\r\n    static load(url: string, complete?: Handler, progress?: Handler): void;\r\n    static open(url: string, closeOther?: boolean, param?: any, complete?: Handler, progress?: Handler): void;\r\n    private static _onSceneLoaded;\r\n    static close(url: string, name?: string): boolean;\r\n    static closeAll(): void;\r\n    static destroy(url: string, name?: string): boolean;\r\n    static gc(): void;\r\n    static setLoadingPage(loadPage: Scene): void;\r\n    static showLoadingPage(param?: any, delay?: number): void;\r\n    private static _showLoading;\r\n    private static _hideLoading;\r\n    static hideLoadingPage(delay?: number): void;\r\n}\r\n"
  }
}

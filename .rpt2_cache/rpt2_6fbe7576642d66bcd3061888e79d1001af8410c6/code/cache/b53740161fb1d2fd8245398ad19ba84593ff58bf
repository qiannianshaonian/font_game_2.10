{
  "code": "import { Event } from \"./Event\";\r\nimport { TouchManager } from \"./TouchManager\";\r\nimport { Input } from \"../display/Input\";\r\nimport { Point } from \"../maths/Point\";\r\nimport { Rectangle } from \"../maths/Rectangle\";\r\nimport { Browser } from \"../utils/Browser\";\r\nimport { ILaya } from \"../../ILaya\";\r\nexport class MouseManager {\r\n    constructor() {\r\n        this.mouseX = 0;\r\n        this.mouseY = 0;\r\n        this.disableMouseEvent = false;\r\n        this.mouseDownTime = 0;\r\n        this.mouseMoveAccuracy = 2;\r\n        this._event = new Event();\r\n        this._captureSp = null;\r\n        this._captureChain = [];\r\n        this._captureExlusiveMode = false;\r\n        this._hitCaputreSp = false;\r\n        this._point = new Point();\r\n        this._rect = new Rectangle();\r\n        this._lastMoveTimer = 0;\r\n        this._prePoint = new Point();\r\n        this._touchIDs = {};\r\n        this._curTouchID = NaN;\r\n        this._id = 1;\r\n    }\r\n    __init__(stage, canvas) {\r\n        this._stage = stage;\r\n        var _this = this;\r\n        canvas.oncontextmenu = function (e) {\r\n            if (MouseManager.enabled)\r\n                return false;\r\n        };\r\n        canvas.addEventListener('mousedown', function (e) {\r\n            if (MouseManager.enabled) {\r\n                if (!Browser.onIE)\r\n                    (e.cancelable) && (e.preventDefault());\r\n                _this.mouseDownTime = Browser.now();\r\n                _this.runEvent(e);\r\n            }\r\n        });\r\n        canvas.addEventListener('mouseup', function (e) {\r\n            if (MouseManager.enabled) {\r\n                (e.cancelable) && (e.preventDefault());\r\n                _this.mouseDownTime = -Browser.now();\r\n                _this.runEvent(e);\r\n            }\r\n        }, true);\r\n        canvas.addEventListener('mousemove', function (e) {\r\n            if (MouseManager.enabled) {\r\n                (e.cancelable) && (e.preventDefault());\r\n                var now = Browser.now();\r\n                if (now - _this._lastMoveTimer < 10)\r\n                    return;\r\n                _this._lastMoveTimer = now;\r\n                _this.runEvent(e);\r\n            }\r\n        }, true);\r\n        canvas.addEventListener(\"mouseout\", function (e) {\r\n            if (MouseManager.enabled)\r\n                _this.runEvent(e);\r\n        });\r\n        canvas.addEventListener(\"mouseover\", function (e) {\r\n            if (MouseManager.enabled)\r\n                _this.runEvent(e);\r\n        });\r\n        canvas.addEventListener(\"touchstart\", function (e) {\r\n            if (MouseManager.enabled) {\r\n                if (!MouseManager._isFirstTouch && !Input.isInputting)\r\n                    (e.cancelable) && (e.preventDefault());\r\n                _this.mouseDownTime = Browser.now();\r\n                _this.runEvent(e);\r\n            }\r\n        });\r\n        canvas.addEventListener(\"touchend\", function (e) {\r\n            if (MouseManager.enabled) {\r\n                if (!MouseManager._isFirstTouch && !Input.isInputting)\r\n                    (e.cancelable) && (e.preventDefault());\r\n                MouseManager._isFirstTouch = false;\r\n                _this.mouseDownTime = -Browser.now();\r\n                _this.runEvent(e);\r\n            }\r\n            else {\r\n                _this._curTouchID = NaN;\r\n            }\r\n        }, true);\r\n        canvas.addEventListener(\"touchmove\", function (e) {\r\n            if (MouseManager.enabled) {\r\n                (e.cancelable) && (e.preventDefault());\r\n                _this.runEvent(e);\r\n            }\r\n        }, true);\r\n        canvas.addEventListener(\"touchcancel\", function (e) {\r\n            if (MouseManager.enabled) {\r\n                (e.cancelable) && (e.preventDefault());\r\n                _this.runEvent(e);\r\n            }\r\n            else {\r\n                _this._curTouchID = NaN;\r\n            }\r\n        }, true);\r\n        canvas.addEventListener('mousewheel', function (e) {\r\n            if (MouseManager.enabled)\r\n                _this.runEvent(e);\r\n        });\r\n        canvas.addEventListener('DOMMouseScroll', function (e) {\r\n            if (MouseManager.enabled)\r\n                _this.runEvent(e);\r\n        });\r\n    }\r\n    initEvent(e, nativeEvent = null) {\r\n        var _this = this;\r\n        _this._event._stoped = false;\r\n        _this._event.nativeEvent = nativeEvent || e;\r\n        _this._target = null;\r\n        this._point.setTo(e.pageX || e.clientX, e.pageY || e.clientY);\r\n        if (this._stage._canvasTransform) {\r\n            this._stage._canvasTransform.invertTransformPoint(this._point);\r\n            _this.mouseX = this._point.x;\r\n            _this.mouseY = this._point.y;\r\n        }\r\n        _this._event.touchId = e.identifier || 0;\r\n        this._tTouchID = _this._event.touchId;\r\n        var evt;\r\n        evt = TouchManager.I._event;\r\n        evt._stoped = false;\r\n        evt.nativeEvent = _this._event.nativeEvent;\r\n        evt.touchId = _this._event.touchId;\r\n    }\r\n    checkMouseWheel(e) {\r\n        this._event.delta = e.wheelDelta ? e.wheelDelta * 0.025 : -e.detail;\r\n        var _lastOvers = TouchManager.I.getLastOvers();\r\n        for (var i = 0, n = _lastOvers.length; i < n; i++) {\r\n            var ele = _lastOvers[i];\r\n            ele.event(Event.MOUSE_WHEEL, this._event.setTo(Event.MOUSE_WHEEL, ele, this._target));\r\n        }\r\n    }\r\n    onMouseMove(ele) {\r\n        TouchManager.I.onMouseMove(ele, this._tTouchID);\r\n    }\r\n    onMouseDown(ele) {\r\n        if (Input.isInputting && ILaya.stage.focus && ILaya.stage.focus[\"focus\"] && !ILaya.stage.focus.contains(this._target)) {\r\n            var pre_input = ILaya.stage.focus['_tf'] || ILaya.stage.focus;\r\n            var new_input = ele['_tf'] || ele;\r\n            if (new_input instanceof Input && new_input.multiline == pre_input.multiline)\r\n                pre_input['_focusOut']();\r\n            else\r\n                pre_input.focus = false;\r\n        }\r\n        TouchManager.I.onMouseDown(ele, this._tTouchID, this._isLeftMouse);\r\n    }\r\n    onMouseUp(ele) {\r\n        TouchManager.I.onMouseUp(ele, this._tTouchID, this._isLeftMouse);\r\n    }\r\n    check(sp, mouseX, mouseY, callBack) {\r\n        this._point.setTo(mouseX, mouseY);\r\n        sp.fromParentPoint(this._point);\r\n        mouseX = this._point.x;\r\n        mouseY = this._point.y;\r\n        var scrollRect = sp._style.scrollRect;\r\n        if (scrollRect) {\r\n            this._rect.setTo(scrollRect.x, scrollRect.y, scrollRect.width, scrollRect.height);\r\n            if (!this._rect.contains(mouseX, mouseY))\r\n                return false;\r\n        }\r\n        if (!this.disableMouseEvent) {\r\n            if (sp.hitTestPrior && !sp.mouseThrough && !this.hitTest(sp, mouseX, mouseY)) {\r\n                return false;\r\n            }\r\n            for (var i = sp._children.length - 1; i > -1; i--) {\r\n                var child = sp._children[i];\r\n                if (!child.destroyed && child._mouseState > 1 && child._visible) {\r\n                    if (this.check(child, mouseX, mouseY, callBack))\r\n                        return true;\r\n                }\r\n            }\r\n            for (i = sp._extUIChild.length - 1; i >= 0; i--) {\r\n                var c = sp._extUIChild[i];\r\n                if (!c.destroyed && c._mouseState > 1 && c._visible) {\r\n                    if (this.check(c, mouseX, mouseY, callBack))\r\n                        return true;\r\n                }\r\n            }\r\n        }\r\n        var isHit = (sp.hitTestPrior && !sp.mouseThrough && !this.disableMouseEvent) ? true : this.hitTest(sp, mouseX, mouseY);\r\n        if (isHit) {\r\n            this._target = sp;\r\n            callBack.call(this, sp);\r\n            if (this._target == this._hitCaputreSp) {\r\n                this._hitCaputreSp = true;\r\n            }\r\n        }\r\n        else if (callBack === this.onMouseUp && sp === this._stage) {\r\n            this._target = this._stage;\r\n            callBack.call(this, this._target);\r\n        }\r\n        return isHit;\r\n    }\r\n    hitTest(sp, mouseX, mouseY) {\r\n        var isHit = false;\r\n        if (sp.scrollRect) {\r\n            mouseX -= sp._style.scrollRect.x;\r\n            mouseY -= sp._style.scrollRect.y;\r\n        }\r\n        var hitArea = sp._style.hitArea;\r\n        if (hitArea && hitArea._hit) {\r\n            return hitArea.contains(mouseX, mouseY);\r\n        }\r\n        if (sp.width > 0 && sp.height > 0 || sp.mouseThrough || hitArea) {\r\n            if (!sp.mouseThrough) {\r\n                isHit = (hitArea ? hitArea : this._rect.setTo(0, 0, sp.width, sp.height)).contains(mouseX, mouseY);\r\n            }\r\n            else {\r\n                isHit = sp.getGraphicBounds().contains(mouseX, mouseY);\r\n            }\r\n        }\r\n        return isHit;\r\n    }\r\n    _checkAllBaseUI(mousex, mousey, callback) {\r\n        var ret = this.handleExclusiveCapture(this.mouseX, this.mouseY, callback);\r\n        if (ret)\r\n            return true;\r\n        ret = this.check(this._stage, this.mouseX, this.mouseY, callback);\r\n        return this.handleCapture(this.mouseX, this.mouseY, callback) || ret;\r\n    }\r\n    check3DUI(mousex, mousey, callback) {\r\n        var uis = this._stage._3dUI;\r\n        var i = 0;\r\n        var ret = false;\r\n        for (; i < uis.length; i++) {\r\n            var curui = uis[i];\r\n            this._stage._curUIBase = curui;\r\n            if (!curui.destroyed && curui._mouseState > 1 && curui._visible) {\r\n                ret = ret || this.check(curui, this.mouseX, this.mouseY, callback);\r\n            }\r\n        }\r\n        this._stage._curUIBase = this._stage;\r\n        return ret;\r\n    }\r\n    handleExclusiveCapture(mousex, mousey, callback) {\r\n        if (this._captureExlusiveMode && this._captureSp && this._captureChain.length > 0) {\r\n            var cursp;\r\n            this._point.setTo(mousex, mousey);\r\n            for (var i = 0; i < this._captureChain.length; i++) {\r\n                cursp = this._captureChain[i];\r\n                cursp.fromParentPoint(this._point);\r\n            }\r\n            this._target = cursp;\r\n            callback.call(this, cursp);\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n    handleCapture(mousex, mousey, callback) {\r\n        if (!this._hitCaputreSp && this._captureSp && this._captureChain.length > 0) {\r\n            var cursp;\r\n            this._point.setTo(mousex, mousey);\r\n            for (var i = 0; i < this._captureChain.length; i++) {\r\n                cursp = this._captureChain[i];\r\n                cursp.fromParentPoint(this._point);\r\n            }\r\n            this._target = cursp;\r\n            callback.call(this, cursp);\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n    runEvent(evt) {\r\n        var _this = this;\r\n        var i, n, touch;\r\n        if (evt.type !== 'mousemove')\r\n            this._prePoint.x = this._prePoint.y = -1000000;\r\n        switch (evt.type) {\r\n            case 'mousedown':\r\n                this._touchIDs[0] = this._id++;\r\n                if (!MouseManager._isTouchRespond) {\r\n                    this._isLeftMouse = evt.button === 0;\r\n                    this.initEvent(evt);\r\n                    this._checkAllBaseUI(this.mouseX, this.mouseY, this.onMouseDown);\r\n                }\r\n                else\r\n                    MouseManager._isTouchRespond = false;\r\n                break;\r\n            case 'mouseup':\r\n                this._isLeftMouse = evt.button === 0;\r\n                this.initEvent(evt);\r\n                this._checkAllBaseUI(this.mouseX, this.mouseY, this.onMouseUp);\r\n                break;\r\n            case 'mousemove':\r\n                if ((Math.abs(this._prePoint.x - evt.clientX) + Math.abs(this._prePoint.y - evt.clientY)) >= this.mouseMoveAccuracy) {\r\n                    this._prePoint.x = evt.clientX;\r\n                    this._prePoint.y = evt.clientY;\r\n                    this.initEvent(evt);\r\n                    this._checkAllBaseUI(this.mouseX, this.mouseY, this.onMouseMove);\r\n                }\r\n                break;\r\n            case \"touchstart\":\r\n                MouseManager._isTouchRespond = true;\r\n                this._isLeftMouse = true;\r\n                var touches = evt.changedTouches;\r\n                for (i = 0, n = touches.length; i < n; i++) {\r\n                    touch = touches[i];\r\n                    if (MouseManager.multiTouchEnabled || isNaN(this._curTouchID)) {\r\n                        this._curTouchID = touch.identifier;\r\n                        if (this._id % 200 === 0)\r\n                            this._touchIDs = {};\r\n                        this._touchIDs[touch.identifier] = this._id++;\r\n                        this.initEvent(touch, evt);\r\n                        this._checkAllBaseUI(this.mouseX, this.mouseY, this.onMouseDown);\r\n                    }\r\n                }\r\n                break;\r\n            case \"touchend\":\r\n            case \"touchcancel\":\r\n                MouseManager._isTouchRespond = true;\r\n                this._isLeftMouse = true;\r\n                var touchends = evt.changedTouches;\r\n                for (i = 0, n = touchends.length; i < n; i++) {\r\n                    touch = touchends[i];\r\n                    if (MouseManager.multiTouchEnabled || touch.identifier == this._curTouchID) {\r\n                        this._curTouchID = NaN;\r\n                        this.initEvent(touch, evt);\r\n                        var isChecked;\r\n                        isChecked = this._checkAllBaseUI(this.mouseX, this.mouseY, this.onMouseUp);\r\n                        if (!isChecked) {\r\n                            this.onMouseUp(null);\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n            case \"touchmove\":\r\n                var touchemoves = evt.changedTouches;\r\n                for (i = 0, n = touchemoves.length; i < n; i++) {\r\n                    touch = touchemoves[i];\r\n                    if (MouseManager.multiTouchEnabled || touch.identifier == this._curTouchID) {\r\n                        this.initEvent(touch, evt);\r\n                        this._checkAllBaseUI(this.mouseX, this.mouseY, this.onMouseMove);\r\n                    }\r\n                }\r\n                break;\r\n            case \"wheel\":\r\n            case \"mousewheel\":\r\n            case \"DOMMouseScroll\":\r\n                this.checkMouseWheel(evt);\r\n                break;\r\n            case \"mouseout\":\r\n                TouchManager.I.stageMouseOut();\r\n                break;\r\n            case \"mouseover\":\r\n                this._stage.event(Event.MOUSE_OVER, this._event.setTo(Event.MOUSE_OVER, this._stage, this._stage));\r\n                break;\r\n        }\r\n    }\r\n    setCapture(sp, exclusive = false) {\r\n        this._captureSp = sp;\r\n        this._captureExlusiveMode = exclusive;\r\n        this._captureChain.length = 0;\r\n        this._captureChain.push(sp);\r\n        var cursp = sp;\r\n        while (true) {\r\n            if (cursp == ILaya.stage)\r\n                break;\r\n            if (cursp == ILaya.stage._curUIBase)\r\n                break;\r\n            cursp = cursp.parent;\r\n            if (!cursp)\r\n                break;\r\n            this._captureChain.splice(0, 0, cursp);\r\n        }\r\n    }\r\n    releaseCapture() {\r\n        console.log('release capture');\r\n        this._captureSp = null;\r\n    }\r\n}\r\nMouseManager.instance = new MouseManager();\r\nMouseManager.enabled = true;\r\nMouseManager.multiTouchEnabled = true;\r\nMouseManager._isFirstTouch = true;\r\n",
  "references": [
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/events/Event.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/events/TouchManager.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/display/Input.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/display/Sprite.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/maths/Point.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/maths/Rectangle.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/utils/Browser.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/laya/display/Stage.ts",
    "/Users/zonst/Documents/font_vivo/font_game_2.10/libs/ILaya.ts"
  ],
  "dts": {
    "name": "/Users/zonst/Documents/font_vivo/font_game_2.10/.rpt2_cache/placeholder/laya/events/MouseManager.d.ts",
    "writeByteOrderMark": false,
    "text": "import { Event } from \"./Event\";\r\nimport { Sprite } from \"../display/Sprite\";\r\nimport { Stage } from \"../display/Stage\";\r\nexport declare class MouseManager {\r\n    static instance: MouseManager;\r\n    static enabled: boolean;\r\n    static multiTouchEnabled: boolean;\r\n    mouseX: number;\r\n    mouseY: number;\r\n    disableMouseEvent: boolean;\r\n    mouseDownTime: number;\r\n    mouseMoveAccuracy: number;\r\n    private static _isTouchRespond;\r\n    _event: Event;\r\n    private _stage;\r\n    private _captureSp;\r\n    private _captureChain;\r\n    private _captureExlusiveMode;\r\n    private _hitCaputreSp;\r\n    private _point;\r\n    private _rect;\r\n    private _target;\r\n    private _lastMoveTimer;\r\n    private _isLeftMouse;\r\n    private _prePoint;\r\n    private _touchIDs;\r\n    private _curTouchID;\r\n    private _id;\r\n    private static _isFirstTouch;\r\n    __init__(stage: Stage, canvas: any): void;\r\n    private _tTouchID;\r\n    private initEvent;\r\n    private checkMouseWheel;\r\n    private onMouseMove;\r\n    private onMouseDown;\r\n    private onMouseUp;\r\n    private check;\r\n    private hitTest;\r\n    private _checkAllBaseUI;\r\n    check3DUI(mousex: number, mousey: number, callback: Function): boolean;\r\n    handleExclusiveCapture(mousex: number, mousey: number, callback: Function): boolean;\r\n    handleCapture(mousex: number, mousey: number, callback: Function): boolean;\r\n    runEvent(evt: any): void;\r\n    setCapture(sp: Sprite, exclusive?: boolean): void;\r\n    releaseCapture(): void;\r\n}\r\n"
  }
}

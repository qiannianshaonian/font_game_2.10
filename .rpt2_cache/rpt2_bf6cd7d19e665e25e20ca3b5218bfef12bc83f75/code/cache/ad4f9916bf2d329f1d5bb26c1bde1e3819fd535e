{
  "code": "import { ILaya } from \"../../../ILaya\";\r\nimport { Stat } from \"../../utils/Stat\";\r\nimport { StringKey } from \"../../utils/StringKey\";\r\nimport { WebGLContext } from \"../WebGLContext\";\r\nimport { BaseShader } from \"./BaseShader\";\r\nimport { LayaGL } from \"../../layagl/LayaGL\";\r\nexport class Shader extends BaseShader {\r\n    constructor(vs, ps, saveName = null, nameMap = null, bindAttrib = null) {\r\n        super();\r\n        this._attribInfo = null;\r\n        this.customCompile = false;\r\n        this._curActTexIndex = 0;\r\n        this.tag = {};\r\n        this._program = null;\r\n        this._params = null;\r\n        this._paramsMap = {};\r\n        if ((!vs) || (!ps))\r\n            throw \"Shader Error\";\r\n        this._attribInfo = bindAttrib;\r\n        this._id = ++Shader._count;\r\n        this._vs = vs;\r\n        this._ps = ps;\r\n        this._nameMap = nameMap ? nameMap : {};\r\n        saveName != null && (Shader.sharders[saveName] = this);\r\n        this.recreateResource();\r\n        this.lock = true;\r\n    }\r\n    static getShader(name) {\r\n        return Shader.sharders[name];\r\n    }\r\n    static create(vs, ps, saveName = null, nameMap = null, bindAttrib = null) {\r\n        return new Shader(vs, ps, saveName, nameMap, bindAttrib);\r\n    }\r\n    static withCompile(nameID, define, shaderName, createShader) {\r\n        if (shaderName && Shader.sharders[shaderName])\r\n            return Shader.sharders[shaderName];\r\n        var pre = Shader._preCompileShader[Shader.SHADERNAME2ID * nameID];\r\n        if (!pre)\r\n            throw new Error(\"withCompile shader err!\" + nameID);\r\n        return pre.createShader(define, shaderName, createShader, null);\r\n    }\r\n    static withCompile2D(nameID, mainID, define, shaderName, createShader, bindAttrib = null) {\r\n        if (shaderName && Shader.sharders[shaderName])\r\n            return Shader.sharders[shaderName];\r\n        var pre = Shader._preCompileShader[Shader.SHADERNAME2ID * nameID + mainID];\r\n        if (!pre)\r\n            throw new Error(\"withCompile shader err!\" + nameID + \" \" + mainID);\r\n        return pre.createShader(define, shaderName, createShader, bindAttrib);\r\n    }\r\n    static addInclude(fileName, txt) {\r\n        ILaya.ShaderCompile.addInclude(fileName, txt);\r\n    }\r\n    static preCompile(nameID, vs, ps, nameMap) {\r\n        var id = Shader.SHADERNAME2ID * nameID;\r\n        Shader._preCompileShader[id] = new ILaya.ShaderCompile(vs, ps, nameMap);\r\n    }\r\n    static preCompile2D(nameID, mainID, vs, ps, nameMap) {\r\n        var id = Shader.SHADERNAME2ID * nameID + mainID;\r\n        Shader._preCompileShader[id] = new ILaya.ShaderCompile(vs, ps, nameMap);\r\n    }\r\n    recreateResource() {\r\n        this._compile();\r\n        this._setGPUMemory(0);\r\n    }\r\n    _disposeResource() {\r\n        WebGLContext.mainContext.deleteShader(this._vshader);\r\n        WebGLContext.mainContext.deleteShader(this._pshader);\r\n        WebGLContext.mainContext.deleteProgram(this._program);\r\n        this._vshader = this._pshader = this._program = null;\r\n        this._params = null;\r\n        this._paramsMap = {};\r\n        this._setGPUMemory(0);\r\n        this._curActTexIndex = 0;\r\n    }\r\n    _compile() {\r\n        if (!this._vs || !this._ps || this._params)\r\n            return;\r\n        this._reCompile = true;\r\n        this._params = [];\r\n        var result;\r\n        if (this.customCompile)\r\n            result = ILaya.ShaderCompile.preGetParams(this._vs, this._ps);\r\n        var gl = WebGLContext.mainContext;\r\n        this._program = gl.createProgram();\r\n        this._vshader = Shader._createShader(gl, this._vs, gl.VERTEX_SHADER);\r\n        this._pshader = Shader._createShader(gl, this._ps, gl.FRAGMENT_SHADER);\r\n        gl.attachShader(this._program, this._vshader);\r\n        gl.attachShader(this._program, this._pshader);\r\n        var one, i, j, n, location;\r\n        var attribDescNum = this._attribInfo ? this._attribInfo.length : 0;\r\n        for (i = 0; i < attribDescNum; i += 2) {\r\n            gl.bindAttribLocation(this._program, this._attribInfo[i + 1], this._attribInfo[i]);\r\n        }\r\n        gl.linkProgram(this._program);\r\n        if (!this.customCompile && !gl.getProgramParameter(this._program, gl.LINK_STATUS)) {\r\n            throw gl.getProgramInfoLog(this._program);\r\n        }\r\n        var nUniformNum = this.customCompile ? result.uniforms.length : gl.getProgramParameter(this._program, gl.ACTIVE_UNIFORMS);\r\n        for (i = 0; i < nUniformNum; i++) {\r\n            var uniform = this.customCompile ? result.uniforms[i] : gl.getActiveUniform(this._program, i);\r\n            location = gl.getUniformLocation(this._program, uniform.name);\r\n            one = { vartype: \"uniform\", glfun: null, ivartype: 1, location: location, name: uniform.name, type: uniform.type, isArray: false, isSame: false, preValue: null, indexOfParams: 0 };\r\n            if (one.name.indexOf('[0]') > 0) {\r\n                one.name = one.name.substr(0, one.name.length - 3);\r\n                one.isArray = true;\r\n                one.location = gl.getUniformLocation(this._program, one.name);\r\n            }\r\n            this._params.push(one);\r\n        }\r\n        for (i = 0, n = this._params.length; i < n; i++) {\r\n            one = this._params[i];\r\n            one.indexOfParams = i;\r\n            one.index = 1;\r\n            one.value = [one.location, null];\r\n            one.codename = one.name;\r\n            one.name = this._nameMap[one.codename] ? this._nameMap[one.codename] : one.codename;\r\n            this._paramsMap[one.name] = one;\r\n            one._this = this;\r\n            one.uploadedValue = [];\r\n            switch (one.type) {\r\n                case gl.INT:\r\n                    one.fun = one.isArray ? this._uniform1iv : this._uniform1i;\r\n                    break;\r\n                case gl.FLOAT:\r\n                    one.fun = one.isArray ? this._uniform1fv : this._uniform1f;\r\n                    break;\r\n                case gl.FLOAT_VEC2:\r\n                    one.fun = one.isArray ? this._uniform_vec2v : this._uniform_vec2;\r\n                    break;\r\n                case gl.FLOAT_VEC3:\r\n                    one.fun = one.isArray ? this._uniform_vec3v : this._uniform_vec3;\r\n                    break;\r\n                case gl.FLOAT_VEC4:\r\n                    one.fun = one.isArray ? this._uniform_vec4v : this._uniform_vec4;\r\n                    break;\r\n                case gl.SAMPLER_2D:\r\n                    one.fun = this._uniform_sampler2D;\r\n                    break;\r\n                case gl.SAMPLER_CUBE:\r\n                    one.fun = this._uniform_samplerCube;\r\n                    break;\r\n                case gl.FLOAT_MAT4:\r\n                    one.glfun = gl.uniformMatrix4fv;\r\n                    one.fun = this._uniformMatrix4fv;\r\n                    break;\r\n                case gl.BOOL:\r\n                    one.fun = this._uniform1i;\r\n                    break;\r\n                case gl.FLOAT_MAT2:\r\n                case gl.FLOAT_MAT3:\r\n                    throw new Error(\"compile shader err!\");\r\n                default:\r\n                    throw new Error(\"compile shader err!\");\r\n            }\r\n        }\r\n    }\r\n    static _createShader(gl, str, type) {\r\n        var shader = gl.createShader(type);\r\n        gl.shaderSource(shader, str);\r\n        gl.compileShader(shader);\r\n        if (gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {\r\n            return shader;\r\n        }\r\n        else {\r\n            console.log(gl.getShaderInfoLog(shader));\r\n            return null;\r\n        }\r\n    }\r\n    getUniform(name) {\r\n        return this._paramsMap[name];\r\n    }\r\n    _uniform1f(one, value) {\r\n        var uploadedValue = one.uploadedValue;\r\n        if (uploadedValue[0] !== value) {\r\n            WebGLContext.mainContext.uniform1f(one.location, uploadedValue[0] = value);\r\n            return 1;\r\n        }\r\n        return 0;\r\n    }\r\n    _uniform1fv(one, value) {\r\n        if (value.length < 4) {\r\n            var uploadedValue = one.uploadedValue;\r\n            if (uploadedValue[0] !== value[0] || uploadedValue[1] !== value[1] || uploadedValue[2] !== value[2] || uploadedValue[3] !== value[3]) {\r\n                WebGLContext.mainContext.uniform1fv(one.location, value);\r\n                uploadedValue[0] = value[0];\r\n                uploadedValue[1] = value[1];\r\n                uploadedValue[2] = value[2];\r\n                uploadedValue[3] = value[3];\r\n                return 1;\r\n            }\r\n            return 0;\r\n        }\r\n        else {\r\n            WebGLContext.mainContext.uniform1fv(one.location, value);\r\n            return 1;\r\n        }\r\n    }\r\n    _uniform_vec2(one, value) {\r\n        var uploadedValue = one.uploadedValue;\r\n        if (uploadedValue[0] !== value[0] || uploadedValue[1] !== value[1]) {\r\n            WebGLContext.mainContext.uniform2f(one.location, uploadedValue[0] = value[0], uploadedValue[1] = value[1]);\r\n            return 1;\r\n        }\r\n        return 0;\r\n    }\r\n    _uniform_vec2v(one, value) {\r\n        if (value.length < 2) {\r\n            var uploadedValue = one.uploadedValue;\r\n            if (uploadedValue[0] !== value[0] || uploadedValue[1] !== value[1] || uploadedValue[2] !== value[2] || uploadedValue[3] !== value[3]) {\r\n                WebGLContext.mainContext.uniform2fv(one.location, value);\r\n                uploadedValue[0] = value[0];\r\n                uploadedValue[1] = value[1];\r\n                uploadedValue[2] = value[2];\r\n                uploadedValue[3] = value[3];\r\n                return 1;\r\n            }\r\n            return 0;\r\n        }\r\n        else {\r\n            WebGLContext.mainContext.uniform2fv(one.location, value);\r\n            return 1;\r\n        }\r\n    }\r\n    _uniform_vec3(one, value) {\r\n        var uploadedValue = one.uploadedValue;\r\n        if (uploadedValue[0] !== value[0] || uploadedValue[1] !== value[1] || uploadedValue[2] !== value[2]) {\r\n            WebGLContext.mainContext.uniform3f(one.location, uploadedValue[0] = value[0], uploadedValue[1] = value[1], uploadedValue[2] = value[2]);\r\n            return 1;\r\n        }\r\n        return 0;\r\n    }\r\n    _uniform_vec3v(one, value) {\r\n        WebGLContext.mainContext.uniform3fv(one.location, value);\r\n        return 1;\r\n    }\r\n    _uniform_vec4(one, value) {\r\n        var uploadedValue = one.uploadedValue;\r\n        if (uploadedValue[0] !== value[0] || uploadedValue[1] !== value[1] || uploadedValue[2] !== value[2] || uploadedValue[3] !== value[3]) {\r\n            WebGLContext.mainContext.uniform4f(one.location, uploadedValue[0] = value[0], uploadedValue[1] = value[1], uploadedValue[2] = value[2], uploadedValue[3] = value[3]);\r\n            return 1;\r\n        }\r\n        return 0;\r\n    }\r\n    _uniform_vec4v(one, value) {\r\n        WebGLContext.mainContext.uniform4fv(one.location, value);\r\n        return 1;\r\n    }\r\n    _uniformMatrix2fv(one, value) {\r\n        WebGLContext.mainContext.uniformMatrix2fv(one.location, false, value);\r\n        return 1;\r\n    }\r\n    _uniformMatrix3fv(one, value) {\r\n        WebGLContext.mainContext.uniformMatrix3fv(one.location, false, value);\r\n        return 1;\r\n    }\r\n    _uniformMatrix4fv(one, value) {\r\n        WebGLContext.mainContext.uniformMatrix4fv(one.location, false, value);\r\n        return 1;\r\n    }\r\n    _uniform1i(one, value) {\r\n        var uploadedValue = one.uploadedValue;\r\n        if (uploadedValue[0] !== value) {\r\n            WebGLContext.mainContext.uniform1i(one.location, uploadedValue[0] = value);\r\n            return 1;\r\n        }\r\n        return 0;\r\n    }\r\n    _uniform1iv(one, value) {\r\n        WebGLContext.mainContext.uniform1iv(one.location, value);\r\n        return 1;\r\n    }\r\n    _uniform_ivec2(one, value) {\r\n        var uploadedValue = one.uploadedValue;\r\n        if (uploadedValue[0] !== value[0] || uploadedValue[1] !== value[1]) {\r\n            WebGLContext.mainContext.uniform2i(one.location, uploadedValue[0] = value[0], uploadedValue[1] = value[1]);\r\n            return 1;\r\n        }\r\n        return 0;\r\n    }\r\n    _uniform_ivec2v(one, value) {\r\n        WebGLContext.mainContext.uniform2iv(one.location, value);\r\n        return 1;\r\n    }\r\n    _uniform_vec3i(one, value) {\r\n        var uploadedValue = one.uploadedValue;\r\n        if (uploadedValue[0] !== value[0] || uploadedValue[1] !== value[1] || uploadedValue[2] !== value[2]) {\r\n            WebGLContext.mainContext.uniform3i(one.location, uploadedValue[0] = value[0], uploadedValue[1] = value[1], uploadedValue[2] = value[2]);\r\n            return 1;\r\n        }\r\n        return 0;\r\n    }\r\n    _uniform_vec3vi(one, value) {\r\n        WebGLContext.mainContext.uniform3iv(one.location, value);\r\n        return 1;\r\n    }\r\n    _uniform_vec4i(one, value) {\r\n        var uploadedValue = one.uploadedValue;\r\n        if (uploadedValue[0] !== value[0] || uploadedValue[1] !== value[1] || uploadedValue[2] !== value[2] || uploadedValue[3] !== value[3]) {\r\n            WebGLContext.mainContext.uniform4i(one.location, uploadedValue[0] = value[0], uploadedValue[1] = value[1], uploadedValue[2] = value[2], uploadedValue[3] = value[3]);\r\n            return 1;\r\n        }\r\n        return 0;\r\n    }\r\n    _uniform_vec4vi(one, value) {\r\n        WebGLContext.mainContext.uniform4iv(one.location, value);\r\n        return 1;\r\n    }\r\n    _uniform_sampler2D(one, value) {\r\n        var gl = WebGLContext.mainContext;\r\n        var uploadedValue = one.uploadedValue;\r\n        if (uploadedValue[0] == null) {\r\n            uploadedValue[0] = this._curActTexIndex;\r\n            gl.uniform1i(one.location, this._curActTexIndex);\r\n            WebGLContext.activeTexture(gl, gl.TEXTURE0 + this._curActTexIndex);\r\n            WebGLContext.bindTexture(gl, gl.TEXTURE_2D, value);\r\n            this._curActTexIndex++;\r\n            return 1;\r\n        }\r\n        else {\r\n            WebGLContext.activeTexture(gl, gl.TEXTURE0 + uploadedValue[0]);\r\n            WebGLContext.bindTexture(gl, gl.TEXTURE_2D, value);\r\n            return 0;\r\n        }\r\n    }\r\n    _uniform_samplerCube(one, value) {\r\n        var gl = WebGLContext.mainContext;\r\n        var uploadedValue = one.uploadedValue;\r\n        if (uploadedValue[0] == null) {\r\n            uploadedValue[0] = this._curActTexIndex;\r\n            gl.uniform1i(one.location, this._curActTexIndex);\r\n            WebGLContext.activeTexture(gl, gl.TEXTURE0 + this._curActTexIndex);\r\n            WebGLContext.bindTexture(gl, gl.TEXTURE_CUBE_MAP, value);\r\n            this._curActTexIndex++;\r\n            return 1;\r\n        }\r\n        else {\r\n            WebGLContext.activeTexture(gl, gl.TEXTURE0 + uploadedValue[0]);\r\n            WebGLContext.bindTexture(gl, gl.TEXTURE_CUBE_MAP, value);\r\n            return 0;\r\n        }\r\n    }\r\n    _noSetValue(one) {\r\n        console.log(\"no....:\" + one.name);\r\n    }\r\n    uploadOne(name, value) {\r\n        WebGLContext.useProgram(WebGLContext.mainContext, this._program);\r\n        var one = this._paramsMap[name];\r\n        one.fun.call(this, one, value);\r\n    }\r\n    uploadTexture2D(value) {\r\n        var CTX = WebGLContext;\r\n        if (CTX._activeTextures[0] !== value) {\r\n            CTX.bindTexture(WebGLContext.mainContext, LayaGL.instance.TEXTURE_2D, value);\r\n            CTX._activeTextures[0] = value;\r\n        }\r\n    }\r\n    upload(shaderValue, params = null) {\r\n        BaseShader.activeShader = BaseShader.bindShader = this;\r\n        var gl = WebGLContext.mainContext;\r\n        WebGLContext.useProgram(gl, this._program);\r\n        if (this._reCompile) {\r\n            params = this._params;\r\n            this._reCompile = false;\r\n        }\r\n        else {\r\n            params = params || this._params;\r\n        }\r\n        var one, value, n = params.length, shaderCall = 0;\r\n        for (var i = 0; i < n; i++) {\r\n            one = params[i];\r\n            if ((value = shaderValue[one.name]) !== null)\r\n                shaderCall += one.fun.call(this, one, value);\r\n        }\r\n        Stat.shaderCall += shaderCall;\r\n    }\r\n    uploadArray(shaderValue, length, _bufferUsage) {\r\n        BaseShader.activeShader = this;\r\n        BaseShader.bindShader = this;\r\n        WebGLContext.useProgram(WebGLContext.mainContext, this._program);\r\n        var params = this._params, value;\r\n        var one, shaderCall = 0;\r\n        for (var i = length - 2; i >= 0; i -= 2) {\r\n            one = this._paramsMap[shaderValue[i]];\r\n            if (!one)\r\n                continue;\r\n            value = shaderValue[i + 1];\r\n            if (value != null) {\r\n                _bufferUsage && _bufferUsage[one.name] && _bufferUsage[one.name].bind();\r\n                shaderCall += one.fun.call(this, one, value);\r\n            }\r\n        }\r\n        Stat.shaderCall += shaderCall;\r\n    }\r\n    getParams() {\r\n        return this._params;\r\n    }\r\n    setAttributesLocation(attribDesc) {\r\n        this._attribInfo = attribDesc;\r\n    }\r\n}\r\nShader._count = 0;\r\nShader._preCompileShader = {};\r\nShader.SHADERNAME2ID = 0.0002;\r\nShader.nameKey = new StringKey();\r\nShader.sharders = new Array(0x20);\r\n",
  "references": [
    "/Users/zonst/Documents/font2.0/font_game_2.10/libs/ILaya.ts",
    "/Users/zonst/Documents/font2.0/font_game_2.10/libs/laya/utils/Stat.ts",
    "/Users/zonst/Documents/font2.0/font_game_2.10/libs/laya/utils/StringKey.ts",
    "/Users/zonst/Documents/font2.0/font_game_2.10/libs/laya/webgl/utils/ShaderCompile.ts",
    "/Users/zonst/Documents/font2.0/font_game_2.10/libs/laya/webgl/WebGLContext.ts",
    "/Users/zonst/Documents/font2.0/font_game_2.10/libs/laya/webgl/shader/BaseShader.ts",
    "/Users/zonst/Documents/font2.0/font_game_2.10/libs/laya/webgl/shader/ShaderValue.ts",
    "/Users/zonst/Documents/font2.0/font_game_2.10/libs/laya/layagl/LayaGL.ts"
  ],
  "dts": {
    "name": "/Users/zonst/Documents/font2.0/font_game_2.10/libs/laya/webgl/shader/Shader.d.ts",
    "writeByteOrderMark": false,
    "text": "import { StringKey } from \"../../utils/StringKey\";\r\nimport { BaseShader } from \"./BaseShader\";\r\nimport { ShaderValue } from \"./ShaderValue\";\r\nexport declare class Shader extends BaseShader {\r\n    private static _count;\r\n    static _preCompileShader: any;\r\n    private _attribInfo;\r\n    static SHADERNAME2ID: number;\r\n    static nameKey: StringKey;\r\n    static sharders: any[];\r\n    static getShader(name: any): Shader;\r\n    static create(vs: string, ps: string, saveName?: any, nameMap?: any, bindAttrib?: any[]): Shader;\r\n    static withCompile(nameID: number, define: any, shaderName: any, createShader: Function): Shader;\r\n    static withCompile2D(nameID: number, mainID: number, define: any, shaderName: any, createShader: Function, bindAttrib?: any[]): Shader;\r\n    static addInclude(fileName: string, txt: string): void;\r\n    static preCompile(nameID: number, vs: string, ps: string, nameMap: any): void;\r\n    static preCompile2D(nameID: number, mainID: number, vs: string, ps: string, nameMap: any): void;\r\n    private customCompile;\r\n    private _nameMap;\r\n    private _vs;\r\n    private _ps;\r\n    private _curActTexIndex;\r\n    private _reCompile;\r\n    tag: any;\r\n    _vshader: any;\r\n    _pshader: any;\r\n    _program: any;\r\n    _params: any[];\r\n    _paramsMap: any;\r\n    constructor(vs: string, ps: string, saveName?: any, nameMap?: any, bindAttrib?: any[] | null);\r\n    protected recreateResource(): void;\r\n    protected _disposeResource(): void;\r\n    private _compile;\r\n    private static _createShader;\r\n    getUniform(name: string): any;\r\n    private _uniform1f;\r\n    private _uniform1fv;\r\n    private _uniform_vec2;\r\n    private _uniform_vec2v;\r\n    private _uniform_vec3;\r\n    private _uniform_vec3v;\r\n    private _uniform_vec4;\r\n    private _uniform_vec4v;\r\n    private _uniformMatrix2fv;\r\n    private _uniformMatrix3fv;\r\n    private _uniformMatrix4fv;\r\n    private _uniform1i;\r\n    private _uniform1iv;\r\n    private _uniform_ivec2;\r\n    private _uniform_ivec2v;\r\n    private _uniform_vec3i;\r\n    private _uniform_vec3vi;\r\n    private _uniform_vec4i;\r\n    private _uniform_vec4vi;\r\n    private _uniform_sampler2D;\r\n    private _uniform_samplerCube;\r\n    private _noSetValue;\r\n    uploadOne(name: string, value: any): void;\r\n    uploadTexture2D(value: any): void;\r\n    upload(shaderValue: ShaderValue, params?: any[]): void;\r\n    uploadArray(shaderValue: any[], length: number, _bufferUsage: any): void;\r\n    getParams(): any[];\r\n    setAttributesLocation(attribDesc: any[]): void;\r\n}\r\n"
  }
}

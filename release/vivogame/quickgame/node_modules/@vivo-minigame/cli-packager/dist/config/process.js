"use strict";var _interopRequireWildcard=require("@babel/runtime-corejs2/helpers/interopRequireWildcard"),_interopRequireDefault=require("@babel/runtime-corejs2/helpers/interopRequireDefault"),_Object$defineProperty=require("@babel/runtime-corejs2/core-js/object/define-property");_Object$defineProperty(exports,"__esModule",{value:!0}),exports.singleConfig=singleConfig,exports.multiConfig=multiConfig,exports.checkError=checkError;var _keys=_interopRequireDefault(require("@babel/runtime-corejs2/core-js/object/keys")),_assign=_interopRequireDefault(require("@babel/runtime-corejs2/core-js/object/assign")),_copyWebpackPlugin=_interopRequireDefault(require("copy-webpack-plugin")),_path=_interopRequireDefault(require("path")),_webpackInjectPlugin=_interopRequireWildcard(require("webpack-inject-plugin")),_webpackZipPlugin=_interopRequireDefault(require("../plugins/webpack-zip-plugin")),_webpackMainPlugin=_interopRequireDefault(require("../plugins/webpack-main-plugin")),_webpackMerge=_interopRequireDefault(require("webpack-merge")),_cliSharedUtils=require("@vivo-minigame/cli-shared-utils"),_webpack=_interopRequireDefault(require("./webpack.config")),_manifest=require("../lib/manifest"),paths=_interopRequireWildcard(require("../lib/paths")),_readdir=_interopRequireDefault(require("../lib/readdir")),_exConfig=_interopRequireDefault(require("../lib/exConfig")),_constanst=require("../lib/constanst");// import path from 'path'
/**
 * 获取基础配置
 * @param {Boolean} isRelease 是否是release包
 * @param {Object} entry 根据分包配置生成的webpack 入口配置
 * @param {Array} pluginPath 插件包路径
 */function base(a,b,c){const d=c&&(0,_readdir.default)(_path.default.resolve(_cliSharedUtils.projectPath,c)),e=c?d.map(a=>({from:_path.default.resolve(_cliSharedUtils.projectPath,c,a),to:_path.default.resolve(paths.BUILD,c,a)})):[],f=(0,_webpackMerge.default)(_webpack.default,{optimization:{minimize:a},devtool:a?"none":"source-map",entry:(0,_assign.default)({game:paths.ENTRY},b),plugins:[new _copyWebpackPlugin.default([{from:paths.SRC,ignore:[..._constanst.FILE_EXT_IGNORES.map(a=>`*${a}`),...[]],// resConfig是为了忽略掉分包中的资源
transform(b,c){// 拷贝manifest.json时，更新里面的config信息
return-1===c.indexOf(_constanst.MANIFEST)?b:(0,_manifest.update)({content:b,isRelease:a})}},...e])]});return(0,_exConfig.default)(f,{context:paths.PROJECT_PATH,src:paths.SRC,build:paths.BUILD}),f}/**
 * 获取打原整包的配置
 * @param {String} entry 根据分包配置生成的webpack 入口配置
 * @param {Boolean} isRelease 是否是release模式
 * @param {String} packageName 包名
 * @param {Object} externals webpack配置使用
 * @param {Boolean} inject 是否注入对分包模块的依赖
 * @param {Array} subpackages 分包配置
 * @param {String} pluginPath 插件包路径
 * @param {Boolean} isStreamPack 是否开启流式打包
 * @param {Object} manifest 小游戏配置文件
 * @param {String} buildType 小游戏构建类型
 */function singleConfig(a,b,c,d,e,f,g,h,i,j){const k=base(b,a,g),l=e?[new _webpackInjectPlugin.default(()=>(0,_keys.default)(d).reduce((a,b)=>`require('${b}');${a}`,""),{entryName:_constanst.ENTRY_NAME,entryOrder:_webpackInjectPlugin.ENTRY_ORDER.Last})]:[];// 是否注入对分包模块的依赖，如果不注入，由CP用户注入，能力开放给CP用户
return(0,_webpackMerge.default)(k,{externals:d,plugins:[new _webpackMainPlugin.default({singlePackage:!0}),new _webpackZipPlugin.default({isRelease:b,packageName:c,singlePackage:!0,// 打原整包
pluginPath:g,subpackages:f,isStreamPack:h,manifest:i,buildType:j}),...l]})}/**
 * 获取打分包的配置
 * @param {String} entry 根据分包配置生成的webpack 入口配置
 * @param {Boolean} isRelease 是否是isRelease模式
 * @param {String} packageName 包名
 * @param {Object} externals webpack配置使用
 * @param {Array} subpackages 分包配置
 * @param {String} pluginPath 插件包路径
 * @param {Boolean} isStreamPack 是否开启流式打包
 * @param {Object} manifest 小游戏配置文件
 * @param {String} buildType 小游戏构建类型
 */function multiConfig(a,b,c,d,e,f,g,h,i){const j=base(b,a,f);return(0,_webpackMerge.default)(j,{externals:d,plugins:[new _webpackMainPlugin.default({singlePackage:!1,subpackages:e}),new _webpackZipPlugin.default({isRelease:b,packageName:c,singlePackage:!1,// 打新分包，为false必须提供subpackages
subpackages:e,pluginPath:f,isStreamPack:g,manifest:h,buildType:i})]})}/**
 * 检查webpack编译完成后是否有错误
 * @param {Object} err webpack错误
 * @param {Object} stats 编译状态
 */function checkError(a,b){if(a)return(0,_cliSharedUtils.error)(a.stack||a),a.details&&(0,_cliSharedUtils.error)(a.details),!0;const c=b.toJson();if(b.hasWarnings()&&(0,_cliSharedUtils.warn)(c.warnings),b.hasErrors())return(0,_cliSharedUtils.error)(c.errors),!0}
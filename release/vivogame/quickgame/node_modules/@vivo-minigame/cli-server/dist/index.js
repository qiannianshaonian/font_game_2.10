"use strict";var _interopRequireDefault=require("@babel/runtime-corejs2/helpers/interopRequireDefault"),_Object$defineProperty=require("@babel/runtime-corejs2/core-js/object/define-property");_Object$defineProperty(exports,"__esModule",{value:!0}),exports.initServer=initServer,exports.stopServer=stopServer,_Object$defineProperty(exports,"notifyUpdate",{enumerable:!0,get:function(){return _notify.default}});var _promise=_interopRequireDefault(require("@babel/runtime-corejs2/core-js/promise")),_koa=_interopRequireDefault(require("koa")),_path=_interopRequireDefault(require("path")),_koaStatic=_interopRequireDefault(require("koa-static")),_http=_interopRequireDefault(require("http")),_internalIp=_interopRequireDefault(require("internal-ip")),_koaBodyparser=_interopRequireDefault(require("koa-bodyparser")),_qrcodeTerminal=_interopRequireDefault(require("qrcode-terminal")),_koaRouter=_interopRequireDefault(require("koa-router")),_portfinder=_interopRequireDefault(require("portfinder")),_router=require("./router"),_logger=require("./logger"),_recordClient=require("./record-client.js"),_notify=_interopRequireDefault(require("./notify")),_wsserver=require("./wsserver"),_adb=require("./adb");// import { warn } from '@vivo-minigame/cli-shared-utils'
let server=null;async function initServer(){const a=new _koa.default,b=new _koaRouter.default,c=await _portfinder.default.getPortPromise();a.use((0,_koaBodyparser.default)()),a.use((0,_koaStatic.default)(_path.default.resolve(__dirname,"./client"))),a.use(_logger.logger),a.use(b.get("/",_router.indexRouter).routes()),a.use(b.get("/bundle",_router.bundleRouter).routes()),a.use(b.post("/poststdbg",_router.poststdbgRouter).routes()),a.use(b.get("/debug",_router.debugRouter).routes()),server=_http.default.Server(a.callback()),beforeStart(server,a,c),a.on("error",a=>{console.error("server error",a)});const d=_internalIp.default.v4.sync();return server.listen(c,()=>{console.log(`地址 http://${d}:${c}`),console.log("\u8BF7\u786E\u4FDD\u624B\u673A\u4E0EApp Server\u5904\u4E8E\u76F8\u540C\u7F51\u6BB5"),_qrcodeTerminal.default.generate(`http://${d}:${c}`,{small:!0})}),`http://${d}:${c}`}function stopServer(){return new _promise.default(a=>{if(!server)return void a({stopServerError:"no server"});try{server.close(b=>{a({stopServerError:b})})}catch(b){throw console.error(`### App Server ### 服务器关闭失败: ${b.message}`),a({stopServerError:b}),b}})}async function beforeStart(a,b,c){await(0,_wsserver.createSocketServer)(a,b),b.context.adbDebugger=(0,_adb.createADBDebugger)({pathClientLog:_recordClient.clientRecordPath,localReversePort:c})}
"use strict";var _interopRequireDefault=require("@babel/runtime-corejs2/helpers/interopRequireDefault"),_Object$defineProperty=require("@babel/runtime-corejs2/core-js/object/define-property");_Object$defineProperty(exports,"__esModule",{value:!0}),exports.startDebug=startDebug,exports.indexRouter=indexRouter,exports.bundleRouter=bundleRouter,exports.poststdbgRouter=poststdbgRouter,exports.debugRouter=debugRouter;var _path=_interopRequireDefault(require("path")),_child_process=require("child_process"),_qrImage=_interopRequireDefault(require("qr-image")),_openBrowser=require("./openBrowser"),_cliSharedUtils=require("@vivo-minigame/cli-shared-utils"),_recordClient=require("./record-client");function indexRouter(a){// 默认展示二维码
const b=_qrImage.default.image(`http://${a.host}`,{size:9});a.type="image/png",a.body=b}function debugRouter(a){const b=a.request.querystring,c=b.replace("ip=","");a.response.type="html",a.response.body=`<p>请复制以下地址到地址栏里面访问（某些高版本chorme可能会导致地址访问不了，去掉“chorme-”尝试下）</p><p>${`chrome-devtools://devtools/bundled/inspector.html?v8only=true&ws=${c}:5086/00010002-0003-4004-8005-000600070008`}</p>`}function poststdbgRouter(a){const b=(0,_recordClient.getDebugInfoFromRequest)(a.request),{ip:c,isPreviewDebug:d=!1}=a.request.body,e=a.request.host;// ADB调试模式
if(b.linkMode===_recordClient.LINK_MODE.ADB)return void startDebug(a,b);const f=`http://${a.host}/html/inspector/inspector.html?ws=${c}:${b.devicePort}/inspector&remoteFrontend=true&dockSide=undocked`;d?(0,_openBrowser.openBrowser)(f):(0,_openBrowser.openBrowser)(`http://${e}/debug?ip=${c}`)}/**
 * 适配支持调试器的开始调试请求， 自动打开chrome进程
 */async function startDebug(a,b){a.status=200;const{sn:c,linkMode:d,devicePort:e,serverIp:f}=b;let g=e;// ADB调试模式
if(d===_recordClient.LINK_MODE.ADB){const{localReversePort:b,err:d}=await a.adbDebugger.forwardForWsChannel(c,e);if(d)return void console.error(`startDebug(): adb forward 端口映射失败: ${d.message}`);g=b}// 生成调试url，并且向页面输出调试APP信息
const h=`http://${f}:${g}/html/inspector/inspector.html?ws=127.0.0.1:${e}/inspector&remoteFrontend=true&dockSide=undocked`;(0,_openBrowser.openBrowser)(h)}function getProjectName(){const a=_cliSharedUtils.fs.readFileSync(_path.default.resolve(_cliSharedUtils.projectPath,"./src/manifest.json"),"utf8");return JSON.parse(a).package}function bundleRouter(a){const b=getProjectName(),c=_path.default.join(_cliSharedUtils.projectPath,`dist`),d=_path.default.join(c,`${b}.rpk`),e=_path.default.join(c,`${b}.signed.rpk`);_cliSharedUtils.fs.existsSync(d)?(a.body=_cliSharedUtils.fs.createReadStream(d),a.set("Content-Type","text/plain")):_cliSharedUtils.fs.existsSync(e)?(a.body=_cliSharedUtils.fs.createReadStream(e),a.set("Content-Type","text/plain")):((0,_cliSharedUtils.info)(`${c}目录下没有rpk文件，现在运行npm run build命令进行打包`),(0,_child_process.execSync)("npm run build",{cwd:_cliSharedUtils.projectPath,stdio:"inherit"}))}